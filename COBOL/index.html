<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç·šä¸Šé»é¤ç³»çµ± (å«é©—è­‰ç¢¼)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top { height: 150px; object-fit: contain; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">ğŸ¥¤ é£²æ–™é»é¤</a>
        <div class="d-flex align-items-center">
            <div id="guest-area">
                <button class="btn btn-outline-light btn-sm me-2" onclick="showLogin()">ç™»å…¥</button>
                <button class="btn btn-warning btn-sm" onclick="showRegister()">è¨»å†Š</button>
            </div>
            <div id="user-area" class="hidden text-white">
                <span class="me-2">Hi, <span id="nav-username" class="fw-bold">User</span></span>
                <button class="btn btn-info btn-sm me-2" onclick="showHistory()">ğŸ“œ æ­·å²è¨‚å–®</button>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row" id="menu-container">Loading...</div>
    <button class="btn btn-primary position-fixed bottom-0 end-0 m-4 rounded-circle p-3 shadow" onclick="showCart()" style="width: 60px; height: 60px;">
        ğŸ›’ <span id="cart-count" class="badge bg-danger position-absolute top-0 start-100 translate-middle rounded-pill">0</span>
    </button>
</div>

<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">æœƒå“¡ç™»å…¥</h5></div>
            <div class="modal-body">
                <input type="text" id="login-phone" class="form-control mb-2" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
                <input type="password" id="login-pwd" class="form-control mb-2" placeholder="å¯†ç¢¼">
            </div>
            <div class="modal-footer"><button class="btn btn-primary w-100" onclick="login()">ç™»å…¥</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">è¨»å†Šæ–°æœƒå“¡</h5></div>
            <div class="modal-body">
                <input type="text" id="reg-name" class="form-control mb-2" placeholder="å§“å">
                <div class="input-group mb-2">
                    <input type="text" id="reg-phone" class="form-control" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
                    <button class="btn btn-secondary" onclick="sendOtp()" id="btn-otp">å–å¾—é©—è­‰ç¢¼</button>
                </div>
                <input type="text" id="reg-otp" class="form-control mb-2" placeholder="è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼">
                <input type="password" id="reg-pwd" class="form-control mb-2" placeholder="è¨­å®šå¯†ç¢¼">
                <small class="text-muted">* æ¸¬è©¦æ¨¡å¼ï¼šé»æ“Šå–å¾—é©—è­‰ç¢¼å¾Œï¼Œè«‹çœ‹å¾Œå°é»‘ç•«é¢</small>
            </div>
            <div class="modal-footer"><button class="btn btn-warning w-100" onclick="register()">è¨»å†Š</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white"><h5 class="modal-title">ğŸ“œ æˆ‘çš„æ­·å²è¨‚å–®</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><table class="table table-striped"><thead><tr><th>æ™‚é–“</th><th>å“é …</th><th>ç‹€æ…‹</th><th>é‡‘é¡</th></tr></thead><tbody id="history-list"></tbody></table></div>
        </div>
    </div>
</div>

<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ğŸ›’ è³¼ç‰©è»Š</h5></div>
            <div class="modal-body">
                <div id="cart-items"></div>
                <div class="input-group mt-3" id="guest-info-input">
                    <input type="text" id="c-name" class="form-control" placeholder="ç¨±å‘¼">
                    <input type="text" id="c-phone" class="form-control" placeholder="æ‰‹æ©Ÿ">
                </div>
                <div id="user-info-display" class="mt-3 text-success fw-bold hidden">æœƒå“¡ï¼š<span id="display-user"></span></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cart=[];updateCartUI();" data-bs-dismiss="modal">æ¸…ç©º</button>
                <button class="btn btn-success" onclick="checkout()">çµå¸³</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="optionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="modal-title"></h5></div>
            <div class="modal-body">
                <label>ç”œåº¦ï¼š</label><select id="sugar" class="form-select mb-2"><option>æ­£å¸¸ç³–</option><option>åŠç³–</option><option>å¾®ç³–</option><option>ç„¡ç³–</option></select>
                <label>å†°å¡Šï¼š</label><select id="ice" class="form-select mb-3"><option>æ­£å¸¸å†°</option><option>å°‘å†°</option><option>å¾®å†°</option><option>å»å†°</option></select>
                <label>æ•¸é‡ï¼š</label><input type="number" id="qty" class="form-control" value="1" min="1">
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="addToCartConfirm()">åŠ å…¥</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let cart = [], products = [], currentItem = null, currentUser = null;
    window.onload = function() { checkLoginStatus(); fetch('/api/products').then(r=>r.json()).then(d=>{products=d;renderMenu()}); };

    function checkLoginStatus() {
        fetch('/api/status').then(r => r.json()).then(data => {
            if(data.logged_in) {
                currentUser = data;
                document.getElementById('guest-area').classList.add('hidden');
                document.getElementById('user-area').classList.remove('hidden');
                document.getElementById('nav-username').innerText = data.username;
                document.getElementById('guest-info-input').classList.add('hidden');
                document.getElementById('user-info-display').classList.remove('hidden');
                document.getElementById('display-user').innerText = data.username;
            } else {
                currentUser = null;
                document.getElementById('guest-area').classList.remove('hidden');
                document.getElementById('user-area').classList.add('hidden');
                document.getElementById('guest-info-input').classList.remove('hidden');
                document.getElementById('user-info-display').classList.add('hidden');
            }
        });
    }

    function showLogin() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }
    function showRegister() { new bootstrap.Modal(document.getElementById('registerModal')).show(); }

    // ç™¼é€é©—è­‰ç¢¼
    function sendOtp() {
        const phone = document.getElementById('reg-phone').value;
        if(!phone) return alert('è«‹å…ˆè¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼');
        
        const btn = document.getElementById('btn-otp');
        btn.disabled = true;
        btn.innerText = 'ç™¼é€ä¸­...';

        fetch('/api/send_otp', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ phone })
        }).then(r => r.json()).then(res => {
            if(res.status === 'success') {
                alert('é©—è­‰ç¢¼å·²ç™¼é€ï¼è«‹æŸ¥çœ‹ä¼ºæœå™¨é»‘ç•«é¢(Terminal)');
                btn.innerText = 'å·²ç™¼é€';
            } else {
                alert(res.msg);
                btn.disabled = false;
                btn.innerText = 'å–å¾—é©—è­‰ç¢¼';
            }
        });
    }

    function register() {
        const username = document.getElementById('reg-name').value;
        const phone = document.getElementById('reg-phone').value;
        const password = document.getElementById('reg-pwd').value;
        const otp = document.getElementById('reg-otp').value;

        fetch('/api/register', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ username, phone, password, otp })
        }).then(r => r.json()).then(res => {
            if(res.status === 'success') {
                alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
                bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
                showLogin();
            } else { alert(res.msg); }
        });
    }

    function login() {
        const phone = document.getElementById('login-phone').value, password = document.getElementById('login-pwd').value;
        fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone,password}) })
        .then(r=>r.json()).then(res=>{ if(res.status==='success') location.reload(); else alert(res.msg); });
    }
    function logout() { fetch('/api/logout').then(()=>location.reload()); }
    function showHistory() {
        fetch('/api/my_history').then(r=>r.json()).then(list => {
            document.getElementById('history-list').innerHTML = list.length ? list.map(i=>`<tr><td><small>${i.time}</small></td><td>${i.item} ${i.options} x${i.qty}</td><td>${i.status}</td><td>${i.price}</td></tr>`).join('') : '<tr><td colspan="4">ç„¡ç´€éŒ„</td></tr>';
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        });
    }
    
    // é»é¤ç›¸é—œ
    function renderMenu() { document.getElementById('menu-container').innerHTML = products.map(item => `<div class="col-6 col-md-4 mb-4"><div class="card h-100 shadow-sm" onclick="openOption(${item.id})"><img src="/static/${item.image}" class="card-img-top"><div class="card-body text-center p-2"><h5 class="card-title fs-6">${item.name}</h5><p class="text-danger fw-bold">$${item.price}</p></div></div></div>`).join(''); }
    function openOption(id) { currentItem = products.find(p=>p.id===id); new bootstrap.Modal(document.getElementById('optionModal')).show(); }
    function addToCartConfirm() {
        const sugar=document.getElementById('sugar').value, ice=document.getElementById('ice').value, qty=document.getElementById('qty').value;
        cart.push({...currentItem, sugar, ice, qty}); updateCartUI();
        bootstrap.Modal.getInstance(document.getElementById('optionModal')).hide();
    }
    function updateCartUI() {
        document.getElementById('cart-count').innerText = cart.length;
        document.getElementById('cart-items').innerHTML = cart.map((i,idx) => `<div class="d-flex justify-content-between border-bottom py-2"><span>${i.name} (${i.sugar}/${i.ice}) x${i.qty}</span><span>$${i.price*i.qty} <button class="btn btn-sm btn-danger ms-2" onclick="cart.splice(${idx},1);updateCartUI()">x</button></span></div>`).join('') + `<div class="text-end fw-bold mt-2">ç¸½è¨ˆ: $${cart.reduce((a,b)=>a+b.price*b.qty,0)}</div>`;
    }
    function showCart() { new bootstrap.Modal(document.getElementById('cartModal')).show(); }
    function checkout() {
        let name, phone;
        if(currentUser) { name=currentUser.username; phone=currentUser.phone; } else { name=document.getElementById('c-name').value; phone=document.getElementById('c-phone').value; if(!name||!phone) return alert('è«‹å¡«å¯«è³‡æ–™'); }
        if(cart.length===0) return alert('ç©ºè³¼ç‰©è»Š');
        fetch('/api/checkout', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({customer_name:name, customer_phone:phone, items:cart})}).then(r=>r.json()).then(()=>{alert('è¨‚å–®é€å‡º'); cart=[]; updateCartUI(); bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();});
    }
</script>
</body>
</html>