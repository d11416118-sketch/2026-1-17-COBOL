<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç·šä¸Šé»é¤ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-3">
    <h1 class="text-center mb-4">ğŸ¥¤ é£²æ–™é»é¤</h1>
    
    <div class="row" id="menu-container">Loading...</div>

    <button class="btn btn-primary position-fixed bottom-0 end-0 m-4 rounded-circle p-3 shadow" onclick="showCart()" style="width: 60px; height: 60px;">
        ğŸ›’ <span id="cart-count" class="badge bg-danger position-absolute top-0 start-100 translate-middle rounded-pill">0</span>
    </button>
</div>

<div class="modal fade" id="optionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="modal-title"></h5></div>
            <div class="modal-body">
                <label>ç”œåº¦ï¼š</label>
                <select id="sugar" class="form-select mb-2">
                    <option>æ­£å¸¸ç³–</option><option>åŠç³–</option><option>å¾®ç³–</option><option>ç„¡ç³–</option>
                </select>
                <label>å†°å¡Šï¼š</label>
                <select id="ice" class="form-select mb-3">
                    <option>æ­£å¸¸å†°</option><option>å°‘å†°</option><option>å¾®å†°</option><option>å»å†°</option>
                </select>
                <label>æ•¸é‡ï¼š</label>
                <input type="number" id="qty" class="form-control" value="1" min="1">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="addToCartConfirm()">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ğŸ›’ æ‚¨çš„è³¼ç‰©è»Š</h5></div>
            <div class="modal-body">
                <div id="cart-items"></div>
                <div class="input-group mt-3">
                    <input type="text" id="c-name" class="form-control" placeholder="æ‚¨çš„ç¨±å‘¼">
                    <input type="text" id="c-phone" class="form-control" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cart=[] ; updateCartUI();" data-bs-dismiss="modal">æ¸…ç©º</button>
                <button class="btn btn-success" onclick="checkout()">ç¢ºèªçµå¸³</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let cart = [];
    let currentItem = null;
    let products = []; // å­˜èœå–®è³‡æ–™

    // 1. ç¶²é ä¸€è¼‰å…¥ï¼Œå…ˆå»è·Ÿå¾Œç«¯è¦èœå–®
    fetch('/api/products')
        .then(res => res.json())
        .then(data => {
            products = data; // å­˜èµ·ä¾†
            renderMenu();    // ç•«åœ¨ç•«é¢ä¸Š
        });

    function renderMenu() {
        const container = document.getElementById('menu-container');
        container.innerHTML = products.map(item => `
            <div class="col-6 col-md-4 mb-4">
                <div class="card h-100 shadow-sm" onclick="openOption(${item.id})">
                    <img src="/static/${item.image}" class="card-img-top" style="height: 150px; object-fit: contain;">
                    <div class="card-body text-center p-2">
                        <h5 class="card-title fs-6">${item.name}</h5>
                        <p class="card-text text-danger fw-bold">$${item.price}</p>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function openOption(id) {
        currentItem = products.find(p => p.id === id);
        document.getElementById('modal-title').innerText = currentItem.name;
        new bootstrap.Modal(document.getElementById('optionModal')).show();
    }

    function addToCartConfirm() {
        const sugar = document.getElementById('sugar').value;
        const ice = document.getElementById('ice').value;
        const qty = parseInt(document.getElementById('qty').value);
        
        cart.push({ ...currentItem, sugar, ice, qty });
        updateCartUI();
        bootstrap.Modal.getInstance(document.getElementById('optionModal')).hide();
    }

    function updateCartUI() {
        document.getElementById('cart-count').innerText = cart.length;
        document.getElementById('cart-items').innerHTML = cart.map((item, idx) => 
            `<div class="d-flex justify-content-between border-bottom py-2">
                <span>${item.name} (${item.sugar}/${item.ice}) x${item.qty}</span>
                <span>$${item.price * item.qty} <button class="btn btn-sm btn-danger ms-2" onclick="cart.splice(${idx},1);updateCartUI()">x</button></span>
             </div>`
        ).join('') + `<div class="text-end fw-bold mt-2">ç¸½è¨ˆ: $${cart.reduce((a,b)=>a+b.price*b.qty,0)}</div>`;
    }

    function showCart() { new bootstrap.Modal(document.getElementById('cartModal')).show(); }

    function checkout() {
        const name = document.getElementById('c-name').value;
        const phone = document.getElementById('c-phone').value;
        if(!name || !phone || cart.length === 0) return alert('è«‹å¡«å¯«è³‡æ–™ä¸¦é¸è³¼å•†å“');

        fetch('/api/checkout', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ customer_name: name, customer_phone: phone, items: cart })
        })
        .then(res => res.json())
        .then(data => {
            alert('è¨‚å–®å·²é€å‡ºï¼');
            cart = [];
            updateCartUI();
            bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
        });
    }
</script>
</body>
</html>