<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åº—å“¡ç®¡ç†ç³»çµ± (POS)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">

<div class="container py-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-6"><h2 class="fw-bold"><i class="fas fa-utensils"></i> å¾Œå°ç®¡ç†ç³»çµ±</h2></div>
        <div class="col-md-6 text-end">
            <div class="card bg-secondary text-white d-inline-block p-2">
                <div class="input-group">
                    <input type="text" id="staff-name" class="form-control bg-dark text-white border-secondary" placeholder="å“¡å·¥å§“å">
                    <button class="btn btn-success" onclick="clockIn('ä¸Šç­')">ä¸Šç­</button>
                    <button class="btn btn-danger" onclick="clockIn('ä¸‹ç­')">ä¸‹ç­</button>
                </div>
                <div id="clock-status" class="small text-warning mt-1"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card bg-secondary mb-3 border-0">
                <div class="card-header bg-warning text-dark fw-bold">ğŸ”¥ å¾…è£½ä½œ (Pending)</div>
                <div class="card-body bg-light text-dark p-0"><table class="table mb-0"><tbody id="pending-list"></tbody></table></div>
            </div>
            <div class="card bg-secondary border-0">
                <div class="card-header bg-success text-white fw-bold">ğŸ“œ å·²å®Œæˆ (History)</div>
                <div class="card-body bg-light text-dark p-0"><table class="table mb-0"><tbody id="completed-list"></tbody></table></div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card bg-secondary mb-3 border-0">
                <div class="card-header bg-info text-dark fw-bold">ğŸ“‹ æ‰“å¡ç´€éŒ„</div>
                <div class="card-body bg-light text-dark p-0"><table class="table table-sm mb-0"><tbody id="attendance-list"></tbody></table></div>
            </div>

            <div class="card bg-dark border-secondary">
                <div class="card-header bg-primary text-white fw-bold">ğŸ“¦ å•†å“ä¸Šä¸‹æ¶</div>
                <div class="card-body">
                    <form id="add-product-form" class="mb-3">
                        <input type="text" name="name" class="form-control mb-2" placeholder="å•†å“åç¨± (å¦‚: çç å¥¶èŒ¶)" required>
                        <input type="number" name="price" class="form-control mb-2" placeholder="åƒ¹æ ¼" required>
                        <input type="file" name="image" class="form-control mb-2" accept="image/*" required>
                        <button type="submit" class="btn btn-primary w-100">â• ä¸Šæ¶æ–°å•†å“</button>
                    </form>
                    <hr class="text-white">
                    <h6 class="text-white">ç›®å‰æ¶ä¸Šå•†å“ï¼š</h6>
                    <ul id="product-list" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">
                        </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // å®šæ™‚åˆ·æ–°è¨‚å–®
    setInterval(loadData, 5000); 
    window.onload = function() { loadData(); loadProducts(); };

    // 1. è¼‰å…¥è¨‚å–®èˆ‡æ‰“å¡
    function loadData() {
        fetch('/api/admin/data').then(r => r.json()).then(d => {
            renderList('pending-list', d.pending, true);
            renderList('completed-list', d.completed, false);
            document.getElementById('attendance-list').innerHTML = d.attendance.map(i => 
                `<tr><td>${i.time.split(' ')[1]}</td><td>${i.name}</td><td>${i.action}</td></tr>`).join('');
        });
    }

    function renderList(id, list, isPending) {
        document.getElementById(id).innerHTML = list.length ? list.map(i => `
            <tr>
                <td>${i.time.split(' ')[1]}</td>
                <td>${i.name}<br><small>${i.items.join('<br>')}</small></td>
                ${isPending ? `<td><button class="btn btn-sm btn-success" onclick="complete('${i.phone}','${i.time}')">OK</button></td>` : ''}
            </tr>`).join('') : '<tr><td colspan="3" class="text-center text-muted">ç„¡è³‡æ–™</td></tr>';
    }

    // 2. è¼‰å…¥å•†å“åˆ—è¡¨
    function loadProducts() {
        fetch('/api/products').then(r => r.json()).then(products => {
            document.getElementById('product-list').innerHTML = products.map(p => `
                <li class="list-group-item bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span>${p.name} ($${p.price})</span>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">ä¸‹æ¶</button>
                </li>
            `).join('');
        });
    }

    // 3. ä¸Šæ¶å•†å“ (åŒ…å«åœ–ç‰‡ä¸Šå‚³)
    document.getElementById('add-product-form').onsubmit = function(e) {
        e.preventDefault();
        const formData = new FormData(this); // è‡ªå‹•æ‰“åŒ…æ–‡å­—å’Œåœ–ç‰‡
        fetch('/api/products', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(res => {
                if(res.status === 'success') {
                    alert('ä¸Šæ¶æˆåŠŸï¼');
                    this.reset();
                    loadProducts(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('å¤±æ•—ï¼š' + res.msg);
                }
            });
    };

    // 4. ä¸‹æ¶å•†å“
    function deleteProduct(id) {
        if(!confirm('ç¢ºå®šè¦ä¸‹æ¶å—ï¼Ÿ')) return;
        fetch(`/api/products/${id}`, { method: 'DELETE' })
            .then(() => loadProducts());
    }

    // å…¶ä»–åŸæœ‰åŠŸèƒ½
    function complete(phone, time) {
        fetch('/api/complete', { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone, time}) }).then(loadData);
    }
    function clockIn(action) {
        const name = document.getElementById('staff-name').value;
        if(!name) return alert('è«‹è¼¸å…¥å§“å');
        fetch('/api/clockin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, action}) }).then(() => {
            document.getElementById('clock-status').innerText = 'æ‰“å¡æˆåŠŸ'; loadData();
        });
    }
</script>
</body>
</html>