<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åº—å“¡ç®¡ç†ç³»çµ± (POS)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta http-equiv="refresh" content="30">
</head>
<body class="bg-dark text-light">

<div class="container py-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h2 class="fw-bold"><i class="fas fa-utensils"></i> å»šæˆ¿/æ«ƒå°ç®¡ç†ç³»çµ±</h2>
        </div>
        
        <div class="col-md-6 text-end">
            <div class="card bg-secondary text-white d-inline-block p-2">
                <div class="input-group">
                    <span class="input-group-text bg-dark text-white border-secondary">å“¡å·¥å§“å</span>
                    <input type="text" id="staff-name" class="form-control bg-dark text-white border-secondary" placeholder="è«‹è¼¸å…¥åå­—">
                    <button class="btn btn-success" onclick="clockIn('ä¸Šç­')">ä¸Šç­</button>
                    <button class="btn btn-danger" onclick="clockIn('ä¸‹ç­')">ä¸‹ç­</button>
                </div>
                <div id="clock-status" class="mt-1 small text-warning"></div>
            </div>
        </div>
    </div>

    <div class="card bg-secondary mb-4 border-0">
        <div class="card-header bg-info text-dark fw-bold">
            ğŸ“‹ æœ€æ–°æ‰“å¡ç´€éŒ„
        </div>
        <div class="card-body bg-light text-dark p-0">
            <table class="table table-sm mb-0">
                <thead><tr><th>æ™‚é–“</th><th>å“¡å·¥</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody id="attendance-list"></tbody>
            </table>
        </div>
    </div>

    <div class="card bg-secondary mb-4 border-0">
        <div class="card-header bg-warning text-dark fw-bold">
            ğŸ”¥ å¾…è£½ä½œè¨‚å–® (Pending)
        </div>
        <div class="card-body bg-light text-dark p-0">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead><tr><th>æ™‚é–“</th><th>é¡§å®¢</th><th width="40%">å…§å®¹</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="pending-list"></tbody>
            </table>
        </div>
    </div>

    <div class="card bg-secondary border-0">
        <div class="card-header bg-success text-white fw-bold">
            ğŸ“œ ä»Šæ—¥å·²å®Œæˆ (History)
        </div>
        <div class="card-body bg-light text-dark p-0">
            <table class="table table-sm text-muted mb-0">
                <thead><tr><th>æ™‚é–“</th><th>é¡§å®¢</th><th>å…§å®¹</th><th>é‡‘é¡</th></tr></thead>
                <tbody id="completed-list"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    window.onload = loadData;

    function loadData() {
        fetch('/api/admin/data')
            .then(res => res.json())
            .then(data => {
                renderPending(data.pending);
                renderCompleted(data.completed);
                renderAttendance(data.attendance); // æ–°å¢é€™è¡Œ
            });
    }

    // æ¸²æŸ“æ‰“å¡ç´€éŒ„
    function renderAttendance(list) {
        const container = document.getElementById('attendance-list');
        if(list.length === 0) {
            container.innerHTML = '<tr><td colspan="3" class="text-center text-muted">ç„¡ç´€éŒ„</td></tr>';
            return;
        }
        container.innerHTML = list.map(item => `
            <tr>
                <td>${item.time.split(' ')[1]}</td>
                <td>${item.name}</td>
                <td>
                    <span class="badge ${item.action === 'ä¸Šç­' ? 'bg-success' : 'bg-danger'}">
                        ${item.action}
                    </span>
                </td>
            </tr>
        `).join('');
    }

    // æ‰“å¡å‹•ä½œ
    function clockIn(action) {
        const name = document.getElementById('staff-name').value;
        if(!name) { alert('è«‹è¼¸å…¥å“¡å·¥å§“åï¼'); return; }

        fetch('/api/clockin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, action })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('clock-status').innerText = `${name} ${action} æˆåŠŸ!`;
            setTimeout(() => document.getElementById('clock-status').innerText = '', 3000);
            loadData(); // åˆ·æ–°åˆ—è¡¨
        });
    }

    function renderPending(list) {
        const container = document.getElementById('pending-list');
        if (list.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="text-center py-4">ç›®å‰æ²’æœ‰æ–°è¨‚å–®</td></tr>';
            return;
        }
        container.innerHTML = list.map(item => `
            <tr class="fw-bold">
                <td>${item.time.split(' ')[1]}</td>
                <td>${item.name}<br><small class="text-muted">${item.phone}</small></td>
                <td>${item.items.join('<br>')}</td>
                <td><button class="btn btn-success btn-lg w-100" onclick="complete('${item.phone}', '${item.time}')">å‡ºé¤ âœ…</button></td>
            </tr>
        `).join('');
    }

    function renderCompleted(list) {
        const container = document.getElementById('completed-list');
        container.innerHTML = list.map(item => `
            <tr><td>${item.time.split(' ')[1]}</td><td>${item.name}</td><td>${item.items.join(', ')}</td><td>$${item.price}</td></tr>
        `).join('');
    }

    function complete(phone, time) {
        if(!confirm("ç¢ºèªå‡ºé¤ï¼Ÿ")) return;
        fetch('/api/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ phone, time })
        }).then(() => loadData());
    }
</script>
</body>
</html>