<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>1959 製茶所 | 營運後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .sidebar-link.active { background-color: #f3f4f6; color: #e11d48; border-right: 4px solid #e11d48; }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col">
        <div class="h-20 flex items-center px-6 border-b border-gray-100">
            <span class="font-bold text-gray-800 text-lg font-serif">1959 製茶所</span>
        </div>
        <nav class="flex-1 py-4">
            <button onclick="switchTab('orders')" id="tab-btn-orders" class="sidebar-link active flex items-center w-full px-6 py-4 text-gray-500 hover:bg-gray-50 transition">
                <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> 訂單管理
            </button>
            <button onclick="switchTab('members')" id="tab-btn-members" class="sidebar-link flex items-center w-full px-6 py-4 text-gray-500 hover:bg-gray-50 transition">
                <i data-lucide="user-check" class="w-5 h-5 mr-3"></i> 會員管理
            </button>
            <button onclick="switchTab('products')" id="tab-btn-products" class="sidebar-link flex items-center w-full px-6 py-4 text-gray-500 hover:bg-gray-50 transition">
                <i data-lucide="package" class="w-5 h-5 mr-3"></i> 商品管理
            </button>
            <button onclick="switchTab('staff')" id="tab-btn-staff" class="sidebar-link flex items-center w-full px-6 py-4 text-gray-500 hover:bg-gray-50 transition">
                <i data-lucide="users" class="w-5 h-5 mr-3"></i> 員工管理
            </button>
            <a href="/" class="sidebar-link flex items-center px-6 py-4 text-gray-500 hover:bg-gray-50 transition mt-auto border-t border-gray-50">
                <i data-lucide="external-link" class="w-5 h-5 mr-3"></i> 回到前台
            </a>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 h-screen overflow-y-auto">

        <div class="p-8 pb-0">
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-gradient-to-br from-indigo-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg">
                    <p class="text-xs font-bold opacity-80 uppercase tracking-widest mb-2">COBOL 今日總營收</p>
                    <h3 class="text-3xl font-black font-mono" id="cobol-revenue">$0</h3>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl p-6 text-white shadow-lg">
                    <p class="text-xs font-bold opacity-80 uppercase tracking-widest mb-2">本日人氣王</p>
                    <h3 class="text-2xl font-black" id="cobol-popular">-</h3>
                </div>
                <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">AI 稽核狀態</p>
                    <div class="flex items-center space-x-2" id="cobol-audit">
                        <div class="w-3 h-3 bg-gray-300 rounded-full"></div>
                        <span class="font-bold text-gray-500">等待結算...</span>
                    </div>
                </div>
            </div>
        </div>

        <section id="section-orders" class="p-8 space-y-8">
            <div>
                <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="flame" class="w-4 h-4 mr-2 text-rose-500"></i> 待製作訂單
                </h3>
                <div id="pending-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <div>
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-800 flex items-center">
                        <i data-lucide="history" class="w-4 h-4 mr-2 text-gray-400"></i> 歷史訂單查詢
                    </h3>
                    <div class="flex space-x-2 bg-white p-2 rounded-xl shadow-sm border border-gray-100">
                        <input type="date" id="search-start" class="border-none text-sm text-gray-600 focus:ring-0 bg-transparent">
                        <span class="text-gray-400 self-center">~</span>
                        <input type="date" id="search-end" class="border-none text-sm text-gray-600 focus:ring-0 bg-transparent">
                        <button onclick="searchHistory()" class="bg-gray-800 text-white px-4 py-1 rounded-lg text-sm font-bold hover:bg-gray-700">搜尋</button>
                    </div>
                </div>
                <div id="completed-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 opacity-75"></div>
            </div>
        </section>

        <section id="section-members" class="p-8 hidden space-y-8">
            <h2 class="text-2xl font-black text-gray-800 mb-4">會員管理</h2>
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-[10px] font-bold text-gray-400 uppercase tracking-widest border-b border-gray-50">
                            <th class="py-4 px-2">姓名</th>
                            <th class="py-4 px-2">電話</th>
                            <th class="py-4 px-2">註冊時間</th>
                            <th class="py-4 px-2 text-right">操作</th>
                        </tr>
                    </thead>
                    <tbody id="member-list"></tbody>
                </table>
            </div>
        </section>

        <section id="section-products" class="p-8 hidden space-y-6">
            <header><h2 class="text-2xl font-black text-gray-800 mb-4">商品管理</h2></header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 sticky top-4">
                        <h3 class="font-bold text-gray-800 mb-6">新增商品</h3>
                        <form onsubmit="handleAddProduct(event)" class="space-y-4">
                            <input type="text" name="name" placeholder="商品名稱" class="w-full px-4 py-3 bg-gray-50 border-none rounded-xl text-sm" required>
                            <input type="number" name="price" placeholder="價格" class="w-full px-4 py-3 bg-gray-50 border-none rounded-xl text-sm" required>
                            <input type="file" name="image" id="file-input" class="w-full px-4 py-3 bg-gray-50 border-none rounded-xl text-sm" accept="image/*" required>
                            <button type="submit" class="w-full bg-emerald-500 text-white py-4 rounded-xl font-bold hover:bg-emerald-600 shadow-lg shadow-emerald-100">確認上架</button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div id="product-list" class="grid grid-cols-1 divide-y divide-gray-50 bg-white rounded-3xl p-6 shadow-sm"></div>
                </div>
            </div>
        </section>

        <section id="section-staff" class="p-8 hidden space-y-8">
            <h2 class="text-2xl font-black text-gray-800">員工管理</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 space-y-6 text-center">
                        <div id="current-time-display" class="text-3xl font-black text-emerald-500 font-mono">00:00:00</div>
                        <input type="text" id="staff-name" placeholder="員工姓名" class="w-full px-6 py-4 bg-gray-50 border-none rounded-2xl text-center text-xl font-bold">
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="clockIn('上班')" class="bg-emerald-500 text-white py-6 rounded-2xl font-bold text-lg hover:bg-emerald-600 shadow-lg">上班</button>
                            <button onclick="clockIn('下班')" class="bg-gray-100 text-gray-600 py-6 rounded-2xl font-bold text-lg hover:bg-gray-200">下班</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4">打卡報表 (可刪除誤觸)</h3>
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-[10px] font-bold text-gray-400 uppercase tracking-widest border-b border-gray-50">
                                    <th class="py-4 px-2">日期時間</th>
                                    <th class="py-4 px-2">姓名</th>
                                    <th class="py-4 px-2">動作</th>
                                    <th class="py-4 px-2 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        lucide.createIcons();

        // 切換分頁
        function switchTab(tabId) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.getElementById('section-' + tabId).classList.remove('hidden');
            document.getElementById('tab-btn-' + tabId).classList.add('active');
            if(tabId === 'products') fetchProducts();
            if(tabId === 'members') fetchMembers();
        }

        // 讀取管理資料
        let isSearching = false; 
        function fetchAdminData() {
            if (isSearching) return; 

            fetch('/api/admin/data')
                .then(r => r.json())
                .then(data => {
                    renderPending(data.pending);
                    if(!isSearching) renderCompleted(data.completed);
                    renderAttendance(data.attendance);
                });
        }

        function renderPending(list) {
            const container = document.getElementById('pending-list');
            if (list.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-12 text-gray-400">目前沒有待製作訂單</div>`;
                return;
            }
            container.innerHTML = list.map(item => `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative group hover:shadow-md transition">
                    <button onclick="deleteOrder(${item.id})" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="font-bold text-lg text-gray-800">${item.item} <span class="text-rose-500">x${item.qty}</span></h4>
                            <p class="text-xs text-gray-400">${item.options}</p>
                        </div>
                        <span class="bg-rose-100 text-rose-600 text-xs font-bold px-2 py-1 rounded-lg">待製作</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="font-bold text-gray-600">${item.name}</p>
                            <p class="text-xs text-gray-400 font-mono">${item.time.split(' ')[1]}</p>
                        </div>
                        <button onclick="completeOrder('${item.phone}', '${item.time}')" class="bg-gray-800 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-gray-700">完成</button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // 渲染歷史訂單 (包含刪除按鈕)
        function renderCompleted(list) {
            const container = document.getElementById('completed-list');
            container.innerHTML = list.map(item => `
                <div class="bg-white p-4 rounded-xl border border-gray-100 relative group">
                    <button onclick="deleteHistory(${item.id})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-gray-600">${item.item} x${item.qty}</span>
                        <span class="text-xs text-gray-300">${item.name}</span>
                    </div>
                    <div class="text-[10px] text-gray-400 font-mono">${item.time}</div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderAttendance(list) {
            const container = document.getElementById('attendance-list');
            container.innerHTML = list.map(item => `
                <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50">
                    <td class="py-3 px-2 text-xs font-mono text-gray-500">${item.time}</td>
                    <td class="py-3 px-2 font-bold text-gray-700">${item.name}</td>
                    <td class="py-3 px-2"><span class="${item.action === '上班' ? 'bg-emerald-100 text-emerald-600' : 'bg-gray-100 text-gray-500'} text-[10px] font-bold px-2 py-1 rounded-md">${item.action}</span></td>
                    <td class="py-3 px-2 text-right">
                        <button onclick="deleteAttendance(${item.id})" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        // 新增: 取得並渲染會員列表
        function fetchMembers() {
            fetch('/api/members')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('member-list').innerHTML = data.map(m => `
                        <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50">
                            <td class="py-3 px-2 font-bold text-gray-700">${m.name}</td>
                            <td class="py-3 px-2 text-sm text-gray-500">${m.phone}</td>
                            <td class="py-3 px-2 text-xs font-mono text-gray-400">${m.time}</td>
                            <td class="py-3 px-2 text-right">
                                <button onclick="deleteMember(${m.id})" class="text-gray-300 hover:text-red-500 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </td>
                        </tr>
                    `).join('');
                    lucide.createIcons();
                });
        }

        // Actions
        function completeOrder(phone, time) {
            fetch('/api/complete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone, time})
            }).then(() => fetchAdminData());
        }

        function deleteOrder(id) {
            if(!confirm('確定刪除此待製作訂單？')) return;
            fetch(`/api/orders/${id}`, { method: 'DELETE' }).then(() => fetchAdminData());
        }

        function deleteAttendance(id) {
            if(!confirm('確定刪除此打卡？')) return;
            fetch(`/api/attendance/${id}`, { method: 'DELETE' }).then(() => fetchAdminData());
        }

        // 刪除會員
        function deleteMember(id) {
            if(!confirm('確定刪除此會員？這將無法復原。')) return;
            fetch(`/api/members/${id}`, { method: 'DELETE' }).then(() => fetchMembers());
        }

        // 刪除歷史訂單 (這是關鍵，會連動 COBOL)
        function deleteHistory(id) {
            if(!confirm('確定刪除歷史紀錄？這將會影響今日營收統計！')) return;
            fetch(`/api/history/${id}`, { method: 'DELETE' })
                .then(() => {
                    // 如果正在搜尋模式，重新搜尋以刷新列表
                    if(isSearching) searchHistory();
                    else fetchAdminData();
                });
        }

        function searchHistory() {
            const start = document.getElementById('search-start').value;
            const end = document.getElementById('search-end').value;
            if(!start || !end) { alert('請選擇開始與結束日期'); return; }

            isSearching = true; 
            fetch(`/api/history_search?start=${start}&end=${end}`)
                .then(r => r.json())
                .then(data => {
                    renderCompleted(data);
                });
        }

        // Products & Clockin
        function fetchProducts() {
            fetch('/api/products').then(r => r.json()).then(data => {
                document.getElementById('product-list').innerHTML = data.map(p => `
                    <div class="flex items-center justify-between py-4 px-2">
                        <div class="flex items-center space-x-4">
                            <img src="/static/${p.image}" class="w-12 h-12 rounded-lg object-cover bg-gray-100">
                            <div><div class="font-bold text-gray-800">${p.name}</div><div class="text-sm text-rose-500 font-bold">$${p.price}</div></div>
                        </div>
                        <button onclick="deleteProduct(${p.id})" class="text-gray-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                `).join('');
                lucide.createIcons();
            });
        }
        function handleAddProduct(e) {
            e.preventDefault();
            fetch('/api/products', {method: 'POST', body: new FormData(e.target)})
                .then(() => { e.target.reset(); fetchProducts(); });
        }
        function deleteProduct(id) {
            if(confirm('確定刪除?')) fetch(`/api/products/${id}`, {method:'DELETE'}).then(fetchProducts);
        }
        function clockIn(action) {
            const name = document.getElementById('staff-name').value;
            if(!name) return alert('請輸入姓名');
            fetch('/api/clockin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, action})
            }).then(() => {
                alert(action + '成功');
                fetchAdminData();
            });
        }

        setInterval(fetchAdminData, 3000);
        fetchAdminData();
        setInterval(() => {
            const now = new Date();
            document.getElementById('current-time-display').innerText = now.toTimeString().split(' ')[0];
        }, 1000);

        setInterval(() => {
            fetch('/api/cobol_report').then(r=>r.json()).then(d=>{
                if(d.status === "Ready") {
                    document.getElementById('cobol-revenue').innerText = "$" + d.revenue.toLocaleString();
                    document.getElementById('cobol-popular').innerText = d.popular;
                    const el = document.getElementById('cobol-audit');
                    el.innerHTML = d.audit === "PASS_OK" 
                        ? `<div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div><span class="font-bold text-emerald-600">帳務驗算通過</span>`
                        : `<div class="w-3 h-3 bg-red-500 rounded-full animate-ping"></div><span class="font-bold text-red-600">發現異常！</span>`;
                }
            })
        }, 3000);
    </script>
</body>
</html>