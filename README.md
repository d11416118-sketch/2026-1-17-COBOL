========================================================================
           1959 製茶所 (COBOL x Python 混合架構) - 系統操作手冊
========================================================================

本手冊將引導您在新電腦 (Linux/WSL 環境) 上部署並執行本系統。
系統架構：現代化前端 (SPA/Tailwind) + Python Flask 中台 + COBOL 核心報表 + Streamlit 數據戰情室。

目錄：
1. [準備工作] 檔案確認
2. [環境安裝] 安裝必要軟體 (系統層級)
3. [專案設定] 編譯 COBOL 與初始化
4. [啟動主系統] 執行 Flask 伺服器
5. [操作說明] 前後台操作與 COBOL 報表
6. [新增功能] 資料庫視角 (Streamlit 數據戰情室)  <-- NEW!
7. [進階功能] 手機連線方式 (WSL 專用)
8. [疑難排解] 常見錯誤處理

------------------------------------------------------------------------
1. [準備工作] 檔案確認
------------------------------------------------------------------------
請確認您的專案資料夾內包含以下關鍵檔案：

📂 專案資料夾
 ├── app.py           (Python 主程式 - 含資安驗證與轉檔橋接器)
 ├── dashboard.py     (Streamlit 戰情室 - 資料庫全景透視)
 ├── view.cbl         (COBOL 報表核心 - 負責讀取 TXT 並輸出 HTML)
 ├── seed_menu.py     (自動化腳本 - 快速生成菜單與圖片)
 ├── clean_duplicates.py (維護腳本 - 清理重複商品)
 ├── index.html       (前台 - 1959 製茶所 顧客點餐介面)
 ├── admin.html       (後台 - SPA 架構管理介面)
 ├── static/          (靜態資源：含 JS, CSS 與圖片)
 └── orders.txt       (系統自動生成 - Python 與 COBOL 的溝通橋樑)

------------------------------------------------------------------------
2. [環境安裝] 安裝必要軟體 (系統層級)
------------------------------------------------------------------------
請開啟終端機 (Terminal)，依序輸入以下指令以安裝系統基礎工具：

(1) 更新系統清單：
    sudo apt update

(2) 安裝 Python 3、虛擬環境工具與 COBOL 編譯器：
    sudo apt install python3 python3-pip python3-flask python3-venv gnucobol -y
    sudo apt install psmisc -y   (選用：安裝 killall 指令)

------------------------------------------------------------------------
3. [專案設定] 編譯 COBOL 與初始化
------------------------------------------------------------------------
本系統採用「異質整合架構」，需先編譯 COBOL 程式。

(1) 進入專案資料夾：
    cd 您的專案路徑

(2) 編譯 COBOL 報表程式：
    cobc -x -o view.exe view.cbl

(3) 初始化資料庫與菜單 (使用自動化腳本)：
    rm -f shop.db              (先清除舊資料庫，若想保留資料請跳過此行)
    python3 seed_menu.py       (執行種子腳本)

    * 此腳本會自動建立 shop.db，並隨機生成 10-15 種飲品與精美圖片。
    * 同時會自動清理 static 資料夾中未使用的垃圾圖片。

------------------------------------------------------------------------
4. [啟動主系統] 執行 Flask 伺服器
------------------------------------------------------------------------
這是顧客點餐與管理員後台的主程式。

(1) 在終端機輸入：
    python3 app.py

(2) 當看到 "Running on http://0.0.0.0:5000" 代表啟動成功。

------------------------------------------------------------------------
5. [操作說明] 前後台操作與 COBOL 報表
------------------------------------------------------------------------
請開啟瀏覽器 (Chrome/Edge)，輸入網址進行操作。

【A. 顧客自助點餐端】(Web)
網址：http://127.0.0.1:5000/
特色：
  1. **OTP 驗證登入**：輸入手機後，請看「終端機」獲取模擬驗證碼。
  2. **會員歷史紀錄**：登入後可查看過往訂單狀態。
  3. **防篡改機制**：系統後端會強制驗證價格，防止惡意修改金額。

【B. 店員後台管理端】(Web)
網址：http://127.0.0.1:5000/admin
特色：
  1. **SPA 無刷新架構**：切換分頁不會閃爍。
  2. **自動同步 (Auto-Polling)**：訂單與打卡紀錄每 3 秒自動更新。
  3. **訂單製作**：收到黃色「待製作」訂單，點擊完成後變更為綠色。
  4. **商品預覽**：上架商品時可即時預覽圖片。

【C. COBOL 核心報表】(Terminal)
這是本系統的核心靈魂，展示古老語言如何處理現代資料。
操作步驟：
  1. 確保您已經在前台「結帳」至少一筆訂單。
  2. 此時 Python 已自動生成 `orders.txt` (含中文編碼修正)。
  3. 在終端機開啟新分頁，執行：
     ./view.exe

  * 您將看到 COBOL 讀取文字檔，並輸出格式完美的 HTML 表格原始碼。
  * 支援 UTF-8 中文自動對齊 (Byte Alignment)。

------------------------------------------------------------------------
6. [新增功能] 資料庫視角 (Streamlit 數據戰情室)
------------------------------------------------------------------------
這是一個獨立的 Python 儀表板，提供「上帝視角」直接讀取 shop.db，
可查看所有隱藏資訊（如會員加密密碼、所有打卡紀錄、銷售圖表）。

【安裝步驟】(只需做一次)
由於 Linux 系統保護機制，必須使用虛擬環境 (venv) 來安裝相關套件。
 先安裝必要系統套件
 sudo apt update
 sudo apt install python3.13-venv -y

1. 建立虛擬環境：
   python3 -m venv venv

2. 進入虛擬環境 (重要！每次要執行前都要做)：
   source venv/bin/activate
   (成功後，終端機最前面會出現 `(venv)` 字樣)

3. 安裝必要插件 (Pandas, Streamlit, Matplotlib)：
   pip install streamlit pandas matplotlib

【啟動方式】
1. 確保已進入虛擬環境： source venv/bin/activate
2. 執行指令：
   streamlit run dashboard.py

3. 系統會自動開啟瀏覽器，或請手動點擊終端機顯示的網址 (通常是 http://localhost:8501)。

【功能亮點】
- **會員帳密管理**：查看雜湊加密後的密碼字串。
- **即時營收圖表**：自動繪製熱銷商品長條圖與營收趨勢。
- **資料庫全透視**：直接瀏覽 SQLite 內的原始資料表 (Raw Data)。

------------------------------------------------------------------------
7. [進階功能] 手機連線方式 (WSL 專用)
------------------------------------------------------------------------
【方法 A：本機轉發 Port Forwarding】(適合自家 WiFi 固定環境)
優點：IP 固定，適合長期開發。
缺點：設定較繁瑣，手機與電腦必須連在同一個 WiFi 下。
(1) 查詢 Windows IP (PowerShell: ipconfig) -> 例如 192.168.0.100
(2) 查詢 WSL IP (Terminal: ip a 或 ipconfig) -> 例如 172.28.x.x
(3) 設定 Port Forwarding (以管理員身分執行 PowerShell)：
    netsh interface portproxy add v4tov4 listenport=5000 listenaddress=0.0.0.0 connectport=5000 connectaddress=[WSL_IP]
    New-NetFirewallRule -DisplayName "Allow Flask" -Direction Inbound -LocalPort 5000 -Protocol TCP -Action Allow
(4) 手機輸入：http://192.168.0.100:5000  (http://Windows IP:5000)
【方法 B：雲端打洞 Tunneling】(推薦！適合校園/公司網路/Demo展示)
優點：不需設定防火牆、不需查 IP、可跨網段連線 (同學用 4G 也能連)。
缺點：網址是隨機的，關閉視窗後會失效。

(1) 確保 Flask 伺服器已啟動 (例如跑在 Port 5001)。
(2) 開啟一個新的 WSL 終端機分頁，執行以下指令 (免安裝)：
    ssh -R 80:localhost:5001 nokey@localhost.run
    (注意：若您的 Port 是 5000，請將指令中的 5001 改為 5000)
(3) 終端機會顯示一個網址 (例如 https://abc-123.lhr.life)。
(4) 手機直接輸入該網址即可連線。

------------------------------------------------------------------------
8. [疑難排解] 常見錯誤處理
------------------------------------------------------------------------
Q1: 執行 pip install 時出現 "externally-managed-environment" 錯誤？
A1: 這是 Linux 的保護機制。請務必使用虛擬環境：
    1. `source venv/bin/activate`
    2. 再執行 `pip install ...`

Q2: 執行 streamlit run dashboard.py 顯示 "command not found"？
A2: 代表您忘記進入虛擬環境了。請先執行 `source venv/bin/activate`。

Q3: 執行 ./view.exe 沒反應或報錯？
A3: 請確認您有先執行 `python3 app.py` 並完成一次結帳。COBOL 需要 `orders.txt` 才能運作。

Q4: COBOL 報表中文亂碼或跑版？
A4: 請確認 `app.py` 中已包含 `get_byte_aligned_str` 修正函式。本系統已針對 UTF-8 (3 bytes) 中文進行位元組對齊處理。

Q5: 後台一直轉圈圈 (Loading)？
A5: 請按 Ctrl+F5 強制重新整理網頁。這是因為瀏覽器快取了舊版 JavaScript，導致讀取不到新的 API 格式。
========================================================================