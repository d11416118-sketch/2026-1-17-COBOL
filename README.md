========================================================================
           1959 製茶所 (COBOL x Python 混合架構) - 系統操作手冊
========================================================================

本手冊將引導您在新電腦 (Linux/WSL 環境) 上部署並執行本系統。
系統架構：現代化前端 (SPA/Tailwind) + Python Flask 中台 + COBOL 核心報表。

目錄：
1. [準備工作] 檔案確認
2. [環境安裝] 安裝必要軟體
3. [專案設定] 編譯 COBOL 與初始化
4. [啟動系統] 執行伺服器與資料填充
5. [操作說明] 前後台操作與 COBOL 報表
6. [進階功能] 手機連線方式 (WSL 專用)
7. [疑難排解] 常見錯誤處理

------------------------------------------------------------------------
1. [準備工作] 檔案確認
------------------------------------------------------------------------
請確認您的專案資料夾內包含以下關鍵檔案：

📂 專案資料夾
 ├── app.py           (Python 主程式 - 含資安驗證與轉檔橋接器)
 ├── view.cbl         (COBOL 報表核心 - 負責讀取 TXT 並輸出 HTML)
 ├── seed_menu.py     (自動化腳本 - 快速生成菜單與圖片)
 ├── index.html       (前台 - 1959 製茶所 顧客點餐介面)
 ├── admin.html       (後台 - SPA 架構管理介面)
 ├── static/          (靜態資源：含 JS, CSS 與圖片)
 └── orders.txt       (系統自動生成 - Python 與 COBOL 的溝通橋樑)

------------------------------------------------------------------------
2. [環境安裝] 安裝必要軟體
------------------------------------------------------------------------
請開啟終端機 (Terminal)，依序輸入以下指令：

(1) 更新系統清單：
    sudo apt update

(2) 安裝 Python 與 COBOL 編譯器：
    sudo apt install python3 python3-pip python3-flask gnucobol -y
    sudo apt install psmisc -y   (選用：安裝 killall 指令)

------------------------------------------------------------------------
3. [專案設定] 編譯 COBOL 與初始化
------------------------------------------------------------------------
本系統採用「異質整合架構」，需先編譯 COBOL 程式。

(1) 進入專案資料夾：
    cd 您的專案路徑

(2) 編譯 COBOL 報表程式：
    cobc -x -o view.exe view.cbl

(3) 初始化資料庫與菜單 (使用自動化腳本)：
    rm -f shop.db              (先清除舊資料庫)
    python3 seed_menu.py       (執行種子腳本)

    * 此腳本會自動建立 shop.db，並隨機生成 10-15 種飲品與精美圖片。
    * 同時會自動清理 static 資料夾中未使用的垃圾圖片。

------------------------------------------------------------------------
4. [啟動系統] 執行伺服器
------------------------------------------------------------------------
(1) 在終端機輸入：
    python3 app.py

(2) 當看到 "Running on http://0.0.0.0:5000" 代表啟動成功。

------------------------------------------------------------------------
5. [操作說明] 前後台操作與 COBOL 報表
------------------------------------------------------------------------
請開啟瀏覽器 (Chrome/Edge)，輸入網址進行操作。

【A. 顧客自助點餐端】(Web)
網址：http://127.0.0.1:5000/
特色：
  1. **OTP 驗證登入**：輸入手機後，請看「終端機」獲取模擬驗證碼。
  2. **會員歷史紀錄**：登入後可查看過往訂單狀態。
  3. **防篡改機制**：系統後端會強制驗證價格，防止惡意修改金額。

【B. 店員後台管理端】(Web)
網址：http://127.0.0.1:5000/admin
特色：
  1. **SPA 無刷新架構**：切換分頁不會閃爍。
  2. **自動同步 (Auto-Polling)**：訂單與打卡紀錄每 3 秒自動更新。
  3. **訂單製作**：收到黃色「待製作」訂單，點擊完成後變更為綠色。
  4. **商品預覽**：上架商品時可即時預覽圖片。

【C. COBOL 核心報表】(Terminal)
這是本系統的核心靈魂，展示古老語言如何處理現代資料。
操作步驟：
  1. 確保您已經在前台「結帳」至少一筆訂單。
  2. 此時 Python 已自動生成 `orders.txt` (含中文編碼修正)。
  3. 在終端機開啟新分頁，執行：
     ./view.exe

  * 您將看到 COBOL 讀取文字檔，並輸出格式完美的 HTML 表格原始碼。
  * 支援 UTF-8 中文自動對齊 (Byte Alignment)。

------------------------------------------------------------------------
6. [進階功能] 手機連線方式 (WSL 專用)
------------------------------------------------------------------------
(1) 查詢 Windows IP (PowerShell: ipconfig) -> 例如 192.168.0.100
(2) 查詢 WSL IP (Terminal: ip a) -> 例如 172.28.x.x
(3) 設定 Port Forwarding (以管理員身分執行 PowerShell)：
    netsh interface portproxy add v4tov4 listenport=5000 listenaddress=0.0.0.0 connectport=5000 connectaddress=[WSL_IP]
    New-NetFirewallRule -DisplayName "Allow Flask" -Direction Inbound -LocalPort 5000 -Protocol TCP -Action Allow
(4) 手機輸入：http://192.168.0.100:5000

------------------------------------------------------------------------
7. [疑難排解] 常見錯誤處理
------------------------------------------------------------------------
Q1: 執行 ./view.exe 沒反應或報錯？
A1: 請確認您有先執行 `python3 app.py` 並完成一次結帳。COBOL 需要 `orders.txt` 才能運作。

Q2: COBOL 報表中文亂碼或跑版？
A2: 請確認 `app.py` 中已包含 `get_byte_aligned_str` 修正函式。本系統已針對 UTF-8 (3 bytes) 中文進行位元組對齊處理。

Q3: 後台一直轉圈圈 (Loading)？
A3: 請按 Ctrl+F5 強制重新整理網頁。這是因為瀏覽器快取了舊版 JavaScript，導致讀取不到新的 API 格式。

Q4: 圖片顯示不出來？
A4: 請確認圖片檔名副檔名 (png/jpg) 正確。建議使用 `python3 seed_menu.py` 來自動產生標準圖片。
========================================================================