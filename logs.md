# COBOL x Python 混合架構點餐系統 - 開發日誌

## [2026-01-18 19:33] 思考階段：分析現有 API
- 觀察 `app.py` 發現 API 路徑如下：
    - `/api/products`: GET 列出商品, POST 新增商品 (form-data), DELETE 刪除商品.
    - `/api/checkout`: POST 提交訂單.
    - `/api/admin/data`: GET 獲取訂單與打卡資訊.
    - `/api/complete`: POST 完成訂單.
    - `/api/clockin`: POST 打卡.
    - `/api/status`, `/api/login`, `/api/register`, `/api/logout`: 使用者認證相關.
- 決定前端使用 Fetch API 來對接，並保持 SPA (Single Page Application) 的體驗。
- **困難點**：後端邏輯不可更動，因此前端必須精確對接現有的欄位名稱（如 `sugar`, `ice`, `qty` 等）。

## [2026-01-18 19:35] 思考階段：動工開發
- 開始撰寫 `index.html` 的美化版本。
- 決定將 JS 與 CSS 獨立出來存放在 `static/js` 與 `static/css`，讓結構更清晰。
- 會使用 Tailwind CSS 的 `rose` 與 `amber` 色系，營造溫暖且有活力的餐飲氛圍。

## [2026-01-18 19:40] 實作紀錄：完成乘客端改造
- `index.html` 已更新為 Mobile-first 響應式設計。
- 實作了購物車側邊欄、精美的飲品客製化 Modal。
- 串接了登入、註冊、OTP 與結帳 API。
- 下一步：開始改造後台管理介面 `admin.html`。

## [2026-01-18 19:45] 實作紀錄：完成後台管理端改造
- `admin.html` 已更新為專業的多欄式 Dashboard。
- 實作了看板模式的訂單管理，區分「待製作」與「近期完成」。
- 實作了商品管理系統，包含**圖片即時預覽**功能。
- 整合了員工打卡功能。
- 所有操作皆透過 Fetch API 非同步完成，維持 SPA 體驗。

## [2026-01-18 19:46] 思考階段：最終檢查與優化
- 檢查 Lucide 圖標名稱是否正確。
- 確認所有 API 串接口徑與 `app.py` 一致。
- 準備撰寫 `walkthrough.md` 展示成果。

## [2026-01-18 19:58] 視覺優化：整合 AI 生成的 Hero Banner
- 生成了一張符合品牌色調 (Rose & Amber) 的高品質橫幅。
- 更新了 `index.html` 的 Hero Section，採用背景圖 + 漸層遮罩的設計，大幅提升視覺沉浸感。
- 將圖片存放於 `static/banner.png`。

## [2026-01-18 20:08] 功能擴充：撰寫商品批次上架工具 `seed_menu.py`
- 應要求開發獨立腳本，透過 `requests` 串接 `/api/products`。
- 自動隨機分配現有圖片以避免缺圖，並排除已存在的基礎品項。
- 方便使用者快速填充測試資料，提升系統完整度。

## [2026-01-18 20:20] 視覺優化：生成高品質商品實拍圖
- 生成了 8 張具有專業攝影感（白底、棚拍光、玻璃冷凝）的飲品圖片。
- 涵蓋金萱/綠茶、紅茶、珍珠奶茶、鮮奶分層、檸檬、百香果、冬瓜/仙草、芋頭牛奶。
- 更新了 `seed_menu.py`，現在會根據商品名稱關鍵字（如「鮮奶」、「珍珠」）自動分配最合適的實拍圖，大幅提升模擬選單的專業感。

## [2026-01-18 20:45] 功能優化：升級分類列與過濾邏輯
- 針對行動裝置優化，將 `index.html` 的分類按鈕改為**橫向捲動清單**，並隱藏捲軸。
- 採用 Pill Shape 膠囊設計，並強化選中狀態（Rose-600）的視覺反饋。
- 在 `app.js` 中建立精確的**分類對照表 (Mapping Strategy)**，解決「奶茶」與「鮮奶茶」關鍵字重疊的誤判問題。
- 實作了具有容錯能力的 `filterMenu` 函式，支援斜線分隔品項（如：紅/綠鮮奶茶）的精準過濾。

## [2026-01-18 20:52] 系統修復：重複資料清理與精確分類
- 開發了 `clean_duplicates.py` 腳本，自動偵測並刪除名稱重複的商品，保留 ID 最新的一筆，確保資料庫整潔。
- 修正了 `index.html` 與 `app.js` 的過濾邏輯，從「模糊比對」切換為「精確白名單 (Allowlist)」策略。
- 解決了「鮮奶茶」分類中會出現「紅茶」等誤判問題，確保點餐體驗的嚴謹性。

## [2026-01-18 21:00] 資料重啟：全品項重灌與進階配圖
- 再次生成 3 張高品質飲品圖：冰淇淋紅茶 (`img_icecream.jpg`)、多多綠茶 (`img_yakult.jpg`)、蜂蜜檸檬 (`img_honeylemon.jpg`)，補齊產品線視覺。
- 徹底重寫 `seed_menu.py`，導入「清空後重灌 (Wipe & Re-seed)」機制，確保資料庫零重複、零髒資料。
- 升級配圖邏輯：依據關鍵字精準匹配 10 種不同的實拍圖，顯著提升點餐介面的視覺精緻度。

## [2026-01-19 05:40] 視覺完善：新增仙草、布丁、椰果專屬圖片
- 針對配料豐富的飲品，生成 3 張高品質實拍圖：仙草凍 (`img_grassjelly.jpg`)、布丁 (`img_pudding.jpg`)、椰果 (`img_coconutjelly.jpg`)。
- 同步更新 `seed_menu.py` 的配圖邏輯，確保「仙草」、「布丁」、「椰果」等熱門加料品項擁有專屬的視覺效果。

## [2026-01-19 06:00] 視覺巔峰：二度優化配圖與辨識邏輯
- **精準重製圖片**：
    - **鐵觀音** (`img_dark.jpg`)：色澤調整得更淡、更透亮，符合原味茶質感。
    - **熊貓珍珠鮮奶** (`img_freshmilk.jpg`)：改為整杯鮮奶特寫，並確保底部有黑白珍珠。
    - **純奶茶** (`img_milktea.jpg`)：新增無配料純奶茶圖，專供醇香、泰式奶茶使用。
    - **椰果奶茶** (`img_coconutjelly.jpg`)：移除百香果色調，全面改為奶茶底的椰果視覺。
    - **QQ 系列** (`img_qq.jpg`)：新增珍珠與椰果雙配料的實拍圖，完美對應「青茶QQ」。
    - **蜂蜜檸檬** (`img_honeylemon.jpg`)：色澤更淺，且加入兩片修飾用的杯口檸檬片。
- **邏輯智慧化**：大幅更新 `seed_menu.py` 的 `get_image_path` 函式，採用多層級優先權判斷，徹底解決圖片張冠李戴的問題。

## [2026-01-19 06:20] 視覺終章：精準圖片補齊與系統自動清理
- **新增 5 張特製圖片**：
    - **冬瓜玉露** (`img_wintermelon.jpg`)：深褐色純冷飲視覺，修正原本錯誤的色澤。
    - **花鳥那堤** (`img_latte.jpg`) & **通用鮮奶茶** (`img_freshmilktea_common.jpg`)：高品質漸層視覺。
    - **燕麥仁奶茶** (`img_oatmilktea.jpg`)：底部帶有紮實燕麥顆粒感。
    - **檸檬冬瓜** (`img_wintermelon_lemon.jpg`)：深色冬瓜底色搭配新鮮檸檬片。
- **菜單與邏輯精鍊**：
    - 永久移除「青茶QQ」品項，確保菜單簡潔無誤。
    - 重構 `seed_menu.py` 的辨識優先權，確保每一杯飲料都能精準對應新舊素材。
- **自動化維護**：
    - 在 `seed_menu.py` 中實作了 `static/` 資料夾自動清理機制，上架後會自動刪除未被使用的冗餘圖片檔案，維持專案純淨。

## [2026-01-19 06:25] 微調校正：完善純奶茶配圖
- 修正了 `seed_menu.py` 中的辨識邏輯，確保「醇香奶茶」與「泰式奶茶」能夠精準對應到不含珍珠的純奶茶圖片 (`img_milktea.jpg`)。
- 解決了傳統奶茶類別中部分品項誤用珍珠圖的問題，達成最終的視覺細節一致。

## [2026-01-19 06:35] 體驗升等：Toast 通知、動態特效與自動刷新
- **前台 (UX)**：
    - 實作 `showToast` 通訊系統，將「加入購物車」與「結帳成功」等訊息改為優雅的底部通知，取代擾人的彈窗。
    - 新增 `product-card` 懸浮特效：滑鼠移入時卡片上浮並伴隨細微陰影與圖片縮放。
    - 全域按鈕增加 `scale-95` 點擊回饋，提升操作手感。
- **後台 (Admin)**：
    - 開放 **5 秒自動刷新 (Auto-Polling)**：訂單列表現在會自動與資料庫同步。
    - 實作 **無閃爍更新 (Flicker-Free)**：僅在資料有變動時局部更新 DOM，保持使用者視線流暢。
    - 新增 **訂單音效提示**：當有新待製作訂單進來時，自動播放簡短通知音效。

## [2026-01-19 06:45] 後台重大革新：SPA 側邊欄架構與管理優化
- **架構升級**：將 `admin.html` 重構為 SPA (Single Page Application) 模式，採用側邊欄標籤切換，解決原本頁面過於擁擠的問題。
- **三大專業模組**：
    - **訂單管理**：專注於待製作訂單的 Kanban 看板與歷史紀錄。
    - **商品管理**：新增 **[🔍 搜尋商品]** 功能，並將新增表單與列表左右並列，操作更直覺。
    - **員工管理**：獨立的打卡中心，配備大尺寸操作按鈕與即時數位時鐘顯示。
- **邏輯優化**：重寫 `admin.js` 以支援無刷新分頁切換，並在後台同步引入 `showToast` 回饋系統。

## [2026-01-19 06:50] 品牌重塑：重生為「1959 製茶所」
- **核心身份**：將網站名稱由「快點！ Tasty」更名為「1959 製茶所」，致敬 COBOL 語言誕生的 1959 年。
- **Logo 視覺設計**：
    - 精心設計了一款具備「復古幾何感」與「製茶職人標誌」的 SVG 圖標。
    - 前台 Logo 結合了電路板幾何線條與傳統茶飲 S 型曲線。
- **美學調整**：
    - 引入 `font-serif` 與 `font-mono` 的對稱美學，營造「復古工業職人」氛圍。
    - 全面更新 `<title>` 為「1959 製茶所 | 金融級手作茶飲 (Powered by COBOL)」。
- 後台側邊欄導航樣式微調，統一為品牌紅 (`rose-600`) 視覺。

## [2026-01-19 06:55] 品牌細節校正：回歸經典圖標
- **Logo 優化**：應要求將過於複雜的 SVG 回歸為原本的「飲料杯 (cup-soda)」圖標。
- **排版微調**：前台 Logo 區塊改為卡片式圓角背景 (`bg-rose-100`)，並將副標題簡化為「SINCE 1959」，整體層次更清晰。
- **後台一致性**：同步更新後台 Logo，採用翡翠綠 (`bg-emerald-100`) 以示區分，維持品牌設計語言的一致性。

## [2026-01-19 06:58] 品牌視覺定稿：職人徽章 Logo 與 Favicon
- **設計進化**：結合了「飲料杯」圖標與「復古科技感六角徽章」的客製化 SVG Logo，達成了使用者要求的職人手作感。
- **全站 Favicon**：為前台 (`rose-600`) 與後台 (`emerald-600`) 分別設置了對應色系的 SVG Favicon，提升了瀏覽器分頁的辨識度。
- **細節打磨**：Logo 加入了 `hover` 旋轉動畫與背景擴散效果，提升互動趣味性。
[2026-01-19 19:15] 系統安全性修復與 COBOL 整合除錯
1. 資安漏洞修復 (Security Patch)
問題描述：原始 checkout API 直接信任前端傳來的商品價格 (item['price'])，存在惡意使用者透過工具竄改金額（如 1 元買飲料）的風險。

修復方案：

重構結帳邏輯，改為 後端驗證 (Server-side Validation)。

建立 price_map：在結帳當下從資料庫 (shop.db) 撈取最新價格。

強制計算：總金額由 db_price * quantity 算出，完全忽略前端傳來的價格參數，確保帳務安全。

2. COBOL 資料橋接修復 (Legacy Bridge Fix)
問題描述：結帳後雖然資料庫有紀錄，但 orders.txt 未生成，導致 COBOL 程式 (view.exe) 讀不到資料，報表輸出為空。

修復方案：

在 app.py 實作 export_orders_to_cobol() 函式。

設定 Trigger：在 checkout 成功 commit 到資料庫後，自動觸發匯出功能，生成符合 COBOL FD 定義的固定長度文字檔。

3. 中文編碼對齊修正 (UTF-8 Byte Alignment)
問題描述：COBOL 報表出現 文山包0 與價格位移錯亂。

原因：Python 的 ljust 是計算「字元數」，但 UTF-8 中文佔 3 Bytes。導致字串長度超出 COBOL 定義的 Byte 限制 (e.g., Name PIC X(20))，擠壓到後方欄位。

解決方案：

實作黑魔法函式 get_byte_aligned_str(text, width)。

邏輯：將字串轉為 bytes 進行裁切，計算實際 Byte 缺口後再補上空白 (padding)。

結果：成功解決「半個中文字」截斷問題，COBOL 報表現在能完美對齊中文品項與價格。

4. 後台 API 補完
問題描述：後台管理介面出現無限載入 (Loading Spinner)，Log 顯示 /api/admin/data 404 Not Found。

修復方案：

補上缺失的 /api/admin/data 路由，提供訂單與打卡狀態的 JSON 資料。

同步更新 admin.js 以正確解析新的資料結構。